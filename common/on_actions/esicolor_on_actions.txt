on_actions = {
	on_startup = {
		effect = {
			log = "[GetDateText] MustaphaTR's Every State Independent main on_startup begin"

			every_country = {
				if = {
					limit = { is_ai = no }

					country_event = esicolor.1
				}

				add_ideas = aggressive_ai

				setup_generic_advisor_portraits = yes
			}
		}
	}

	on_state_control_changed = {
		effect = {
			log = "[GetDateText] MustaphaTR's Every State Independent main on_state_control_changed begin"

			if = {
				limit = { state = 195 }
				adjust_state_name_195 = yes
			}
			else_if = {
				limit = { state = 217 }
				adjust_state_name_217 = yes
			}
			else_if = {
				limit = { state = 227 }
				adjust_state_name_227 = yes
			}
			else_if = {
				limit = { state = 742 }
				adjust_state_name_742 = yes
			}
		}
	}

	on_ruling_party_change = {
		effect = {
			log = "[GetDateText] MustaphaTR's Every State Independent main on_ruling_party_change begin"

			if = {
				limit = { original_tag = IYS }
				adjust_state_name_195 = yes
			}
			else_if = {
				limit = { original_tag = ZIF }
				adjust_state_name_217 = yes
			}
			else_if = {
				limit = { original_tag = ZZF }
				adjust_state_name_227 = yes
			}
			else_if = {
				limit = { original_tag = FAZ }
				adjust_state_name_742 = yes
			}

			if = {
				limit = { has_global_flag = leader_traits_disabled }

				clear_leader_traits = yes
			}

			if = {
				limit = { has_character = ZIF_iosif_stalin }

				if = {
					limit = { has_government = neutrality }

					ZIF_iosif_stalin = {
						set_character_name = ZIF_tsar_joseph_i

						set_portraits = {
							civilian = {
								large = "GFX_portrait_SOV_tsar_stalin"
							}
							army = {
								large = "GFX_portrait_SOV_tsar_stalin"
							}
						}
					}

					else = {
						ZIF_iosif_stalin = {
							set_character_name = SOV_iosif_stalin

							set_portraits = {
								civilian = {
									large = "GFX_portrait_SOV_iosif_stalin"
								}
								army = {
									large = "GFX_portrait_SOV_iosif_stalin"
								}
							}
						}
					}
				}
			}
		}
	}

	on_daily = {
		effect = {
			log = "[GetDateText] MustaphaTR's Every State Independent main on_daily begin for [Root.GetName]"

			for_each_loop = {
				array = ROOT.states_being_claimed

				if = {
					limit = {
						check_variable = { ROOT.claim_timer_@var:v < 2 }
					}

					add_threat = 1

					var:v = {
						add_claim_by = ROOT

						owner = {
							set_temp_variable = { state_owner = THIS }
						}
					}

					if = {
						limit = {
							var:state_owner = {
								NOT = {
									tag = ROOT
									is_in_faction_with = ROOT
								}
							}
						}

						if = {
							limit = { has_global_flag = claiming_give_war_goals }

							create_wargoal = {
								type = take_state_focus
								target = state_owner
								#generator = { v.id }
							}
						}
						else_if = {
							limit = { has_global_flag = claiming_declare_war }

							hidden_effect = {
								create_wargoal = {
									type = take_state_focus
									target = state_owner
									#generator = { v.id }
								}
							}
							declare_war_on = {
								type = take_state_focus
								target = state_owner
								#generator = { v.id }
							}
						}
					}

					add_to_variable = { ROOT.dynamic_pp_gain_modifier = 0.1 }
					clamp_variable = {
						var = ROOT.dynamic_pp_gain_modifier
						max = 0
						min = -2000
					}
					remove_from_array = {
						array = ROOT.states_being_claimed
						index = i
					}
				}
				else = {
					subtract_from_variable = { ROOT.claim_timer_@var:v = 1 }
				}
			}
			for_each_loop = {
				array = ROOT.states_getting_compliance

				if = {
					limit = {
						check_variable = { ROOT.compliance_timer_@var:v < 2 }
					}

					var:v = {
						add_compliance = 10
					}

					subtract_from_variable = { ROOT.dynamic_civ_factory_use = 1 }
					clamp_variable = {
						var = ROOT.dynamic_civ_factory_use
						min = 0
						max = 2000
					}
					remove_from_array = {
						array = ROOT.states_getting_compliance
						index = i
					}
				}
				else = {
					subtract_from_variable = { ROOT.compliance_timer_@var:v = 1 }
				}
			}
			for_each_loop = {
				array = ROOT.states_being_cored_normal

				if = {
					limit = {
						check_variable = { ROOT.core_timer_@var:v < 2 }
					}

					var:v = {
						add_core_of = ROOT
					}

					add_to_variable = { ROOT.dynamic_pp_gain_modifier = 0.25 }
					clamp_variable = {
						var = ROOT.dynamic_pp_gain_modifier
						max = 0
						min = -2000
					}
					remove_from_array = {
						array = ROOT.states_being_cored_normal
						index = i
					}
				}
				else = {
					subtract_from_variable = { ROOT.core_timer_@var:v = 1 }
				}
			}
			for_each_loop = {
				array = ROOT.states_being_cored_formable

				if = {
					limit = {
						check_variable = { ROOT.core_timer_@var:v < 2 }
					}

					var:v = {
						add_core_of = ROOT
					}

					add_to_variable = { ROOT.dynamic_pp_gain_modifier = 0.125 }
					clamp_variable = {
						var = ROOT.dynamic_pp_gain_modifier
						max = 0
						min = -2000
					}
					remove_from_array = {
						array = ROOT.states_being_cored_formable
						index = i
					}
				}
				else = {
					subtract_from_variable = { ROOT.core_timer_@var:v = 1 }
				}
			}
		}
	}

	on_weekly = { #TODO, split all the AIs to 7 groups and run them at different days of the week.
		effect = {
			log = "[GetDateText] MustaphaTR's Every State Independent main on_weekly begin for [Root.GetName]"

			if = {
				limit = {
					NOT = {
						original_tag = OOO
						has_global_flag = state_management_disabled
						is_ai = no
						has_states_to_form_lv2_or_lv3_formable = yes
					}
				}

				# First, we check if we have something to core
				if = {
					limit = {
						has_political_power > 29
						political_power_daily > 0.125

						any_owned_state = { # seems like any_owned_controlled_state isn't a thing, it is not on wiki at least.
							is_controlled_by = ROOT

							NOT = {
								is_core_of = ROOT

								is_in_array = { ROOT.states_being_cored_formable = THIS }
								is_in_array = { ROOT.states_being_cored_normal = THIS }
							}

							compliance > 20
							is_in_array = { ROOT.formable_cores = THIS }
						}
					}

					random_owned_controlled_state = {
						limit = {
							compliance > 20
							is_in_array = { ROOT.formable_cores = THIS }
						}

						add_to_array = { ROOT.states_being_cored_formable = THIS }
						ROOT = { add_political_power > -30 }
						subtract_from_variable = { ROOT.dynamic_pp_gain_modifier = 0.125 }
						set_variable = { ROOT.core_timer_@THIS = 30 }
					}
				}
				else_if = {
					limit = {
						has_political_power > 59
						political_power_daily > 0.25

						any_owned_state = {
							is_controlled_by = ROOT

							NOT = {
								is_core_of = ROOT

								is_in_array = { ROOT.states_being_cored_formable = THIS }
								is_in_array = { ROOT.states_being_cored_normal = THIS }
							}

							compliance > 40

							OR = {
								any_neighbor_state = {
									is_core_of = ROOT
								}

								is_neighboring_core_special_case_state = yes
							}
						}
					}

					random_owned_controlled_state = {
						limit = {
							compliance > 40

							OR = {
								any_neighbor_state = {
									is_core_of = ROOT
								}

								is_neighboring_core_special_case_state = yes
							}
						}

						add_to_array = { ROOT.states_being_cored_normal = THIS }
						ROOT = { add_political_power > -60 }
						subtract_from_variable = { ROOT.dynamic_pp_gain_modifier = 0.25 }
						set_variable = { ROOT.core_timer_@THIS = 60 }
					}
				}

				# Then, increase compliance if we have little ponypower and states we can core.
				if = {
					limit = {
						has_political_power > 39
						num_of_civilian_factories_available_for_projects > 0

						any_owned_state = {
							is_controlled_by = ROOT

							OR = {
								set_temp_variable = { capital = ROOT.capital_scope }
								check_variable = { state_population_k > capital.state_population_k }
								arms_factory > 2
								industrial_complex > 3
							}

							NOT = {
								is_core_of = ROOT

								is_in_array = { ROOT.states_getting_compliance = THIS }
							}

							if = {
								limit = {
									is_in_array = { ROOT.formable_cores = THIS }
								}

								compliance < 20
							}
							else = {
								compliance < 40

								OR = {
									any_neighbor_state = {
										is_core_of = ROOT
									}

									is_neighboring_core_special_case_state = yes
								}
							}
						}
					}

					random_owned_controlled_state = {
						limit = {
							is_controlled_by = ROOT

							OR = {
								set_temp_variable = { capital = ROOT.capital_scope }
								check_variable = { state_population_k > capital.state_population_k }
								arms_factory > 2
								industrial_complex > 3
							}

							NOT = {
								is_core_of = ROOT

								is_in_array = { ROOT.states_getting_compliance = THIS }
							}

							if = {
								limit = {
									is_in_array = { ROOT.formable_cores = THIS }
								}

								compliance < 20
							}
							else = {
								compliance < 40

								OR = {
									any_neighbor_state = {
										is_core_of = ROOT
									}

									is_neighboring_core_special_case_state = yes
								}
							}
						}

						add_to_array = { ROOT.states_getting_compliance = THIS }
						ROOT = { add_political_power = -40 }
						add_to_variable = { ROOT.dynamic_civ_factory_use = 1 }
						set_variable = { ROOT.compliance_timer_@THIS = 30 }
					}
				}
					
				# If there is nothing to core or get compliance on, let's fight. If we aren't already fighting.
				if = {
					limit = {
						OR = {
							has_war = no
							all_enemy_country = {
								NOT = { is_neighbor_of = ROOT }
							}
						}
						check_variable = { ROOT.states_being_claimed^num < 1 }

						has_political_power > global.claiming_cost_minus_one?19
						political_power_daily > 0.1
					}

					if = {
						limit = {
							any_neighbor_country = {
								NOT = {
									original_tag = OOO
									is_in_faction_with = ROOT
									has_non_aggression_pact_with = ROOT
									ROOT = { has_wargoal_against = PREV }
								}

								any_owned_state = {
									OR = {
										has_global_flag = claiming_give_war_goals
										has_global_flag = claiming_declare_war

										NOT = { is_claimed_by = ROOT }
									}

									any_neighbor_state = {
										is_owned_by = ROOT
									}
								}
							}
						}

						random_neighbor_country = {
							limit = {
								NOT = {
									original_tag = OOO
									is_in_faction_with = ROOT
									has_non_aggression_pact_with = ROOT
									ROOT = { has_wargoal_against = PREV }
								}

								OR = {
									has_global_flag = claiming_give_war_goals
									has_global_flag = claiming_declare_war

									NOT = { any_owned_state = { is_claimed_by = ROOT } }
								}
							}

							random_owned_state = {
								limit = {
									OR = {
										has_global_flag = claiming_give_war_goals
										has_global_flag = claiming_declare_war

										NOT = { is_claimed_by = ROOT }
									}

									any_neighbor_state = {
										is_owned_by = ROOT
									}
								}

								add_to_array = { ROOT.states_being_claimed = THIS }
								ROOT = { add_political_power = global.claiming_cost_negative?-20 }
								subtract_from_variable = { ROOT.dynamic_pp_gain_modifier = 0.1 }
								set_variable = { ROOT.claim_timer_@THIS = global.claiming_length?30 }
							}
						}
					}
					else_if = {
						limit = {
							any_country = {
								NOT = {
									original_tag = OOO
									is_in_faction_with = ROOT
									has_non_aggression_pact_with = ROOT
									ROOT = { has_wargoal_against = PREV }
								}

								OR = {
									has_global_flag = claiming_give_war_goals
									has_global_flag = claiming_declare_war

									NOT = { any_owned_state = { is_claimed_by = ROOT } }
								}

								is_neighboring_ownership_special_case_country = yes
							}
						}

						random_country = {
							limit = {
								NOT = {
									original_tag = OOO
									is_in_faction_with = ROOT
									has_non_aggression_pact_with = ROOT
									ROOT = { has_wargoal_against = PREV }
								}

								OR = {
									has_global_flag = claiming_give_war_goals
									has_global_flag = claiming_declare_war

									NOT = { any_owned_state = { is_claimed_by = ROOT } }
								}

								is_neighboring_ownership_special_case_country = yes
							}

							random_owned_state = {
								limit = {
									is_neighboring_ownership_special_case_state = yes
								}

								add_to_array = { ROOT.states_being_claimed = THIS }
								ROOT = { add_political_power = global.claiming_cost_negative?-20 }
								subtract_from_variable = { ROOT.dynamic_pp_gain_modifier = 0.1 }
								set_variable = { ROOT.claim_timer_@THIS = global.claiming_length?30 }
							}
						}
					}
				}
			}
		}
	}
}

